<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>–ü—Ä–∏–∫–ª—é—á–µ–Ω–∏—è –∏—Å–∫—Ä—ã ‚Äî Improved</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
        body { margin: 0; overflow: hidden; background: linear-gradient(to bottom, #87CEEB, #E0F7FA); font-family: 'Press Start 2P', cursive; }
        #gameUI{position:fixed;top:10px;left:10px;color:white;background:rgba(0,0,0,0.5);padding:10px;border-radius:5px;z-index:10;font-size:0.8rem}
        #inventory,#tools{position:fixed;bottom:20px;display:flex;gap:10px;background:rgba(0,0,0,0.7);padding:10px;border-radius:10px;z-index:10}
        #inventory{left:50%;transform:translateX(-50%)}
        #tools{right:20px}
        .item{width:42px;height:42px;border:2px solid #555;cursor:pointer;background-size:cover;image-rendering:pixelated;position:relative}
        .item.active{border-color:gold;box-shadow:0 0 10px gold}
        .item-count{position:absolute;bottom:2px;right:2px;color:white;font-size:10px;text-shadow:1px 1px 1px black}
        canvas{display:block;image-rendering:pixelated}
        #audioToggle,#helpToggle,#craftButton{position:fixed;padding:5px 10px;background:rgba(0,0,0,0.5);color:white;border:none;border-radius:5px;cursor:pointer;font-size:0.7rem}
        #audioToggle{top:10px;right:10px}
        #helpToggle{top:10px;right:100px}
        #craftButton{bottom:100px;right:20px;background:rgba(100,200,100,0.7);z-index:15}
        #tooltip{position:fixed;bottom:120px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.7);color:white;padding:8px 15px;border-radius:5px;font-size:0.8rem;opacity:0;transition:opacity 0.3s;pointer-events:none}
        #controlsHelp{position:fixed;top:50px;right:20px;background:rgba(0,0,0,0.7);color:white;padding:10px;border-radius:5px;font-size:0.7rem;display:none;z-index:20}
        #dayNightIndicator{position:fixed;top:10px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.5);color:white;padding:5px 10px;border-radius:5px;font-size:0.7rem;z-index:10}
        #blockName{position:fixed;background:rgba(0,0,0,0.7);color:white;padding:5px 10px;border-radius:5px;font-size:0.8rem;pointer-events:none;transform:translate(-50%,-100%);display:none;z-index:100}
        #craftMenu{position:fixed;bottom:150px;right:20px;background:rgba(0,0,0,0.8);padding:15px;border-radius:10px;display:none;flex-direction:column;gap:10px;z-index:15;width:220px}
        .craftRecipe{display:flex;align-items:center;gap:10px;padding:8px;cursor:pointer;border-radius:5px;font-size:0.7rem;color:white}
        .craftRecipe:hover{background:rgba(255,255,255,0.06)}
        .craftRecipe img{width:24px;height:24px;image-rendering:pixelated}
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
</head>
<body>
    <div id="gameUI"></div>
    <div id="dayNightIndicator">–î–µ–Ω—å</div>
    <button id="audioToggle">üîä –ó–≤—É–∫ –í–ö–õ</button>
    <button id="helpToggle">‚ùì –ü–æ–¥—Å–∫–∞–∑–∫–∏</button>
    <button id="craftButton">üß∞ –ö—Ä–∞—Ñ—Ç</button>
    <div id="controlsHelp">
        <div>WASD - –î–≤–∏–∂–µ–Ω–∏–µ</div>
        <div>SPACE - –ü—Ä—ã–∂–æ–∫</div>
        <div>–õ–ö–ú - –°—Ç—Ä–æ–∏—Ç—å</div>
        <div>–ü–ö–ú - –õ–æ–º–∞—Ç—å</div>
        <div>1-9 - –í—ã–±–æ—Ä —Å–ª–æ—Ç–æ–≤</div>
        <div>R - –ú–µ–Ω—é –∫—Ä–∞—Ñ—Ç–∞</div>
    </div>
    <div id="tooltip"></div>
    <canvas id="gameCanvas"></canvas>
    <div id="inventory"></div>
    <div id="tools"></div>
    <div id="blockName"></div>

    <div id="craftMenu">
        <div class="craftRecipe" id="craft_planks">
            <img src="wood.png"> ‚Üí <img src="planks.png">√ó5
            <span style="margin-left:10px;">–î–æ—Å–∫–∞ (1 –±—Ä–µ–≤–Ω–æ ‚Üí 5 –¥–æ—Å–æ–∫)</span>
        </div>
        <div class="craftRecipe" id="craft_workbench">
            <img src="planks.png">√ó15 ‚Üí <img src="workbench.png">
            <span style="margin-left:10px;">–í–µ—Ä—Å—Ç–∞–∫ (15 –¥–æ—Å–æ–∫ ‚Üí 1 –≤–µ—Ä—Å—Ç–∞–∫)</span>
        </div>
    </div>

    <audio id="jumpSound"><source src="jump.wav" type="audio/wav"></audio>
    <audio id="breakSound"><source src="break.wav" type="audio/wav"></audio>
    <audio id="walkSound"><source src="walk.wav" type="audio/wav"></audio>
    <audio id="backgroundMusic" loop><source src="background.mp3" type="audio/mp3"></audio>

<script>
// ====== –ü–∞—Ä–∞–º–µ—Ç—Ä—ã ======
const TILE_SIZE = 42;
const WORLD_WIDTH = 500;
const WORLD_HEIGHT = 100;
const PLAYER_WIDTH = TILE_SIZE * 0.8;
const PLAYER_HEIGHT = TILE_SIZE * 1.8; // —á—É—Ç—å –º–µ–Ω—å—à–µ 2 –±–ª–æ–∫–æ–≤
const CAMERA_SMOOTHING = 0.12;

// –¶–∏–∫–ª –¥–µ–Ω—å/–Ω–æ—á—å: 5 –º–∏–Ω—É—Ç –¥–µ–Ω—å, 1 –º–∏–Ω—É—Ç–∞ –Ω–æ—á—å
const DAY_NIGHT_CYCLE = { day: 300, night: 60 }; // –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
const TRANSITION_MS = 2200; // –ø–ª–∞–≤–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥ 2.2 —Å–µ–∫

// –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–∏—Å—Ç–∞–Ω—Ü–∏—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –±–ª–æ–∫–æ–≤
const PLACE_RANGE_TILES = 5;

// –®–∞–≥ –¥–ª—è "–º–∏–Ω–∏-–ø–æ–¥—ä—ë–º–æ–≤"
const STEP_HEIGHT = Math.floor(TILE_SIZE * 0.6);

const BLOCKS = {
  GRASS:0, DIRT:1, STONE:2, WOOD:3, LEAVES:4, FLOWER:5, PLANKS:6, BEDROCK:7, AIR:8,
  TALL_GRASS:9, MOON_ROCK:10, MOON_FLOWER:11, COAL:12, IRON:13, CAVE_AIR:14,
  WORKBENCH:15, COAL_ITEM:16, SNOW:17, SNOW_GRASS:18, SNOW_DIRT:19, ICE:20
};

const BLOCK_NAMES = {
  [BLOCKS.GRASS]:"–¢—Ä–∞–≤—è–Ω–æ–π –±–ª–æ–∫", [BLOCKS.DIRT]:"–ó–µ–º–ª—è", [BLOCKS.STONE]:"–ö–∞–º–µ–Ω—å",
  [BLOCKS.WOOD]:"–ë—Ä–µ–≤–Ω–æ", [BLOCKS.LEAVES]:"–õ–∏—Å—Ç–≤–∞", [BLOCKS.FLOWER]:"–¶–≤–µ—Ç–æ–∫",
  [BLOCKS.PLANKS]:"–î–æ—Å–∫–∞", [BLOCKS.BEDROCK]:"–ë–µ–¥—Ä–æ–∫", [BLOCKS.TALL_GRASS]:"–¢—Ä–∞–≤–∏–Ω–∫–∞",
  [BLOCKS.MOON_ROCK]:"–õ—É–Ω–Ω—ã–π –∫–∞–º–µ–Ω—å", [BLOCKS.MOON_FLOWER]:"–õ—É–Ω–Ω—ã–π —Ü–≤–µ—Ç–æ–∫",
  [BLOCKS.COAL]:"–£–≥–æ–ª—å–Ω–∞—è —Ä—É–¥–∞", [BLOCKS.IRON]:"–ñ–µ–ª–µ–∑–Ω–∞—è —Ä—É–¥–∞", [BLOCKS.WORKBENCH]:"–í–µ—Ä—Å—Ç–∞–∫",
  [BLOCKS.COAL_ITEM]:"–£–≥–æ–ª—å", [BLOCKS.SNOW]:"–°–Ω–µ–≥", [BLOCKS.SNOW_GRASS]:"–°–Ω–µ–∂–Ω–∞—è —Ç—Ä–∞–≤–∞",
  [BLOCKS.SNOW_DIRT]:"–°–Ω–µ–∂–Ω–∞—è –∑–µ–º–ª—è", [BLOCKS.ICE]:"–õ—ë–¥"
};

const TEXTURES = {
  player_stand: "player_stand.png",
  player_right: "player_right.png",
  player_left:  "player_left.png",
  blocks: {
    [BLOCKS.GRASS]: "grass.png",
    [BLOCKS.DIRT]: "dirt.png",
    [BLOCKS.STONE]: "stone.png",
    [BLOCKS.WOOD]: "wood.png",
    [BLOCKS.LEAVES]: "leaves.png",
    [BLOCKS.FLOWER]: "flower.png",
    [BLOCKS.PLANKS]: "planks.png",
    [BLOCKS.BEDROCK]: "bedrock.png",
    [BLOCKS.TALL_GRASS]: "tall_grass.png",
    [BLOCKS.MOON_ROCK]: "moon_rock.png",
    [BLOCKS.MOON_FLOWER]: "moon_flower.png",
    [BLOCKS.COAL]: "coal.png",
    [BLOCKS.IRON]: "iron.png",
    [BLOCKS.WORKBENCH]: "workbench.png",
    [BLOCKS.SNOW]: "snow.png",
    [BLOCKS.SNOW_GRASS]: "snow_grass.png",
    [BLOCKS.SNOW_DIRT]: "snow_dirt.png",
    [BLOCKS.ICE]: "ice.png"
  },
  items: {
    axe: "axe.png",
    pickaxe: "pickaxe.png",
    shovel: "shovel.png",
    coal: "coal_item.png"
  }
};

// ====== DOM ======
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const inventoryDiv = document.getElementById('inventory');
const toolsDiv = document.getElementById('tools');
const jumpSound = document.getElementById('jumpSound');
const breakSound = document.getElementById('breakSound');
const walkSound = document.getElementById('walkSound');
const backgroundMusic = document.getElementById('backgroundMusic');
const audioToggle = document.getElementById('audioToggle');
const tooltip = document.getElementById('tooltip');
const craftButton = document.getElementById('craftButton');
const craftMenu = document.getElementById('craftMenu');
const helpToggle = document.getElementById('helpToggle');
const controlsHelp = document.getElementById('controlsHelp');
const dayNightIndicator = document.getElementById('dayNightIndicator');
const blockNameDiv = document.getElementById('blockName');

let world = [];
let textures = {};
let camera = { x: 0, y: 0 };
let audioEnabled = true;
let lastTime = 0;
let tooltipTimeout = null;
let showHelp = false;
let isGameActive = true;
let spawnPoint = { x: 0, y: 0 };
let dayNightCycle = { time: 0, isDay: true, transition: 1, transitioning: false };
let snowBiomeStart = 0, snowBiomeEnd = 0;
let snowflakes = [], isSnowing = false, lastSnowflakeTime = 0, snowflakeInterval = 100;

// —Ü–µ–ª—å –¥–≤–∏–∂–µ–Ω–∏—è –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏
let inputTargetVX = 0;

// –∑–≤—É–∫ —à–∞–≥–æ–≤ –∫—É–ª–¥–∞—É–Ω
let lastWalkAt = 0;

const player = {
  x: 300, y: 100, width: PLAYER_WIDTH, height: PLAYER_HEIGHT,
  velX: 0, velY: 0, speed: 3.6, jumpForce: -11,
  isJumping: false, selectedBlock: BLOCKS.GRASS,
  inventory: {}, tools: { axe:false, pickaxe:false, shovel:false },
  facingRight: true, onGround: false, walking:false, lastDirection:1,
  frameTimer:0, frameInterval:160, currentFrame:0, onIce:false, iceTimer:0
};

// ====== –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å ======
function initPlayerInventory(){
  player.inventory = {};
  Object.values(BLOCKS).forEach(b=>{ if(!isNaN(b)) player.inventory[b]=0; });
}

// ====== –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ–∫—Å—Ç—É—Ä ======
function loadTextures(){
  const list = [];
  list.push({name:'player_stand',url:TEXTURES.player_stand});
  list.push({name:'player_right',url:TEXTURES.player_right});
  list.push({name:'player_left',url:TEXTURES.player_left});
  Object.entries(TEXTURES.blocks).forEach(([id,url])=>list.push({name:`block_${id}`,url}));
  Object.entries(TEXTURES.items).forEach(([id,url])=>list.push({name:`item_${id}`,url}));
  let loaded=0; if(list.length===0){ initGame(); return; }
  list.forEach(t=>{
    const img=new Image(); img.src=t.url;
    img.onload=()=>{textures[t.name]=img; if(++loaded===list.length) initGame();};
    img.onerror=()=>{ console.warn('–ù–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è:',t.url); if(++loaded===list.length) initGame(); };
  });
}

// ====== –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –º–∏—Ä–∞ ======
function generateWorld(){
  world = Array(WORLD_HEIGHT).fill().map(()=>Array(WORLD_WIDTH).fill(BLOCKS.AIR));
  // —Å–Ω–µ–∂–Ω—ã–π –±–∏–æ–º
  snowBiomeStart = Math.floor(Math.random()*(WORLD_WIDTH-120))+40;
  snowBiomeEnd = snowBiomeStart + Math.floor(Math.random()*80)+40;

  for(let x=0;x<WORLD_WIDTH;x++){
    const transitionRadius = 8;
    let snowFactor = 0;
    if(x >= snowBiomeStart && x <= snowBiomeEnd) snowFactor = 1;
    else if(x > snowBiomeStart - transitionRadius && x < snowBiomeStart) snowFactor = (x - (snowBiomeStart - transitionRadius)) / transitionRadius;
    else if(x < snowBiomeEnd + transitionRadius && x > snowBiomeEnd) snowFactor = ((snowBiomeEnd + transitionRadius) - x) / transitionRadius;
    snowFactor = Math.max(0, Math.min(1, snowFactor));

    const groundY = Math.floor(WORLD_HEIGHT/2 + Math.sin(x/20)*3 + Math.random()*2);

    for(let y=groundY;y<WORLD_HEIGHT;y++){
      if(y===groundY){
        if(Math.random() > 0.88){ // —á–∞—â–µ —Ç—Ä–∞–≤–∏–Ω–∫–∏/—Ü–≤–µ—Ç—ã
          if(snowFactor > 0.6) world[y-1][x] = BLOCKS.SNOW;
          else world[y-1][x] = Math.random()>0.9?BLOCKS.MOON_FLOWER:(Math.random()>0.5?BLOCKS.FLOWER:BLOCKS.TALL_GRASS);
        }
        if(snowFactor > 0.6) world[y][x] = BLOCKS.SNOW_GRASS;
        else if(snowFactor > 0.3) world[y][x] = Math.random()>0.5?BLOCKS.SNOW_GRASS:BLOCKS.GRASS;
        else world[y][x] = BLOCKS.GRASS;
      }
      else if(y<groundY+3) world[y][x] = snowFactor>0.6?BLOCKS.SNOW_DIRT:BLOCKS.DIRT;
      else if(y>=WORLD_HEIGHT-1-Math.floor(Math.random()*3)) world[y][x]=BLOCKS.BEDROCK;
      else {
        if(Math.random()>0.7) world[y][x] = Math.random()>0.97?BLOCKS.MOON_ROCK:BLOCKS.STONE;
        else world[y][x] = snowFactor>0.6?BLOCKS.SNOW_DIRT:BLOCKS.DIRT;
      }
    }

    // –¥–µ—Ä–µ–≤—å—è
    if(Math.random()>0.97 && groundY>10){
      const th = Math.floor(Math.random()*3)+4;
      const tx = x; const ty = groundY-1;
      for(let y=ty;y>ty-th;y--) if(y>=0) world[y][tx]=BLOCKS.WOOD;
      const lr = 2;
      for(let ly=ty-th-lr; ly<=ty-th+lr; ly++){
        for(let lx=tx-lr; lx<=tx+lr; lx++){
          if(lx>=0 && lx<WORLD_WIDTH && ly>=0 && world[ly][lx]===BLOCKS.AIR && Math.random()>0.3) world[ly][lx]=BLOCKS.LEAVES;
        }
      }
    }

    // –ª—ë–¥ –≤ —Å–Ω–µ–∂–Ω–æ–π –∑–æ–Ω–µ (—Å–ª—É—á–∞–π–Ω—ã–µ –ª–∏–Ω–∑—ã)
    if(snowFactor > 0.4){
      for(let y=groundY+1; y<groundY+7; y++){
        if(y < WORLD_HEIGHT && world[y][x] === BLOCKS.AIR && Math.random() > (0.78 - snowFactor*0.3)){
          world[y][x] = BLOCKS.ICE;
        }
      }
    }

    // —Ä–µ–¥–∫–∞—è —Ç—Ä–∞–≤–∞ –ø–æ–≤–µ—Ä—Ö
    if(Math.random()>0.82 && world[groundY-1] && world[groundY-1][x]===BLOCKS.AIR) {
      world[groundY-1][x] = BLOCKS.TALL_GRASS;
    }
  }
  generateCaves(); generateMines();

  // —Å–ø–∞–≤–Ω –ø–æ —Ü–µ–Ω—Ç—Ä—É –º–∏—Ä–∞ –Ω–∞ –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏
  const centerX = Math.floor(WORLD_WIDTH/2);
  const centerY = findSurfaceY(centerX);
  spawnPoint = { x: centerX * TILE_SIZE, y: (centerY-1) * TILE_SIZE - player.height };
}

function generateCaves(){
  const surface = Math.floor(WORLD_HEIGHT/2);
  const caveCount = Math.floor(Math.random()*4)+3;
  for(let i=0;i<caveCount;i++){
    const cx = Math.floor(Math.random()*(WORLD_WIDTH-20))+10;
    const cy = Math.floor(Math.random()*(WORLD_HEIGHT-surface-10))+surface+10;
    const r = Math.floor(Math.random()*3)+4;
    for(let y=cy-r;y<=cy+r;y++){
      for(let x=cx-r;x<=cx+r;x++){
        if(x>=0 && x<WORLD_WIDTH && y>=0 && y<WORLD_HEIGHT){
          const d = Math.hypot(x-cx,y-cy);
          if(d<=r && Math.random()>0.3){
            world[y][x] = BLOCKS.CAVE_AIR;
            if(d>=r-1 && Math.random()>0.7) world[y][x] = Math.random()>0.5?BLOCKS.COAL:BLOCKS.IRON;
          }
        }
      }
    }
  }
}

function generateMines(){
  const surface = Math.floor(WORLD_HEIGHT/2);
  const mineCount = Math.floor(Math.random()*2)+1;
  for(let i=0;i<mineCount;i++){
    let mx = Math.floor(Math.random()*(WORLD_WIDTH-10))+5;
    const sy = findSurfaceY(mx);
    const depth = Math.floor(Math.random()*20)+30;
    const width = Math.floor(Math.random()*3)+3;
    let curX = mx;
    let dir = Math.random()>0.5?1:-1;
    for(let y=sy;y<sy+depth;y++){
      if(Math.random()>0.9) dir = Math.random()>0.5?1:-1;
      curX += dir; if(curX<0) curX = 0; if(curX>=WORLD_WIDTH) curX = WORLD_WIDTH-1;
      for(let w=-Math.floor(width/2); w<=Math.floor(width/2); w++){
        const x = curX + w;
        if(x>=0 && x<WORLD_WIDTH && y>=0 && y<WORLD_HEIGHT){
          world[y][x] = BLOCKS.CAVE_AIR;
          if((w===-Math.floor(width/2) || w===Math.floor(width/2)) && Math.random()>0.7) world[y][x] = Math.random()>0.5?BLOCKS.COAL:BLOCKS.IRON;
        }
      }
      if(Math.random()>0.95){
        const bl = Math.floor(Math.random()*5)+2;
        const bd = Math.random()>0.5?1:-1;
        for(let b=1;b<=bl;b++){
          const bx = curX + (b*bd);
          const by = y;
          if(bx>=0 && bx<WORLD_WIDTH && by>=0 && by<WORLD_HEIGHT){
            world[by][bx] = BLOCKS.CAVE_AIR;
            if(Math.random()>0.8) world[by][bx] = Math.random()>0.5?BLOCKS.COAL:BLOCKS.IRON;
          }
        }
      }
    }
  }
}

function findSurfaceY(x){
  for(let y=1;y<WORLD_HEIGHT;y++){
    const b = world[y][x];
    if(b!==BLOCKS.AIR && b!==BLOCKS.TALL_GRASS && b!==BLOCKS.FLOWER && b!==BLOCKS.MOON_FLOWER && b!==BLOCKS.SNOW) return y;
  }
  return Math.floor(WORLD_HEIGHT/2);
}

function isSolidBlock(block){
  return block!==BLOCKS.AIR && block!==BLOCKS.CAVE_AIR && block!==BLOCKS.FLOWER && block!==BLOCKS.LEAVES &&
         block!==BLOCKS.TALL_GRASS && block!==BLOCKS.MOON_FLOWER && block!==BLOCKS.SNOW;
}

// ====== –ö–æ–ª–ª–∏–∑–∏–∏ –∏ –ø–æ–º–æ—â–Ω–∏–∫–∏ ======
function getTileAtXY(px, py){
  const gx = Math.floor(px / TILE_SIZE); const gy = Math.floor(py / TILE_SIZE);
  if(gy<0||gy>=WORLD_HEIGHT||gx<0||gx>=WORLD_WIDTH) return BLOCKS.AIR;
  return world[gy][gx];
}

// ====== –î–µ–Ω—å/–ù–æ—á—å —Å –ø–ª–∞–≤–Ω—ã–º –ø–µ—Ä–µ—Ö–æ–¥–æ–º ======
function updateDayNightCycle(deltaTime){
  dayNightCycle.time += deltaTime/1000;
  const duration = dayNightCycle.isDay ? DAY_NIGHT_CYCLE.day : DAY_NIGHT_CYCLE.night;
  if(dayNightCycle.time >= duration){
    dayNightCycle.time = 0;
    dayNightCycle.isDay = !dayNightCycle.isDay;
    dayNightCycle.transitioning = true;
    dayNightCycle.transition = 0;
    dayNightIndicator.textContent = dayNightCycle.isDay ? '–î–µ–Ω—å' : '–ù–æ—á—å';
  }
  if(dayNightCycle.transitioning){
    dayNightCycle.transition += deltaTime / TRANSITION_MS;
    if(dayNightCycle.transition >= 1){ dayNightCycle.transition = 1; dayNightCycle.transitioning = false; }
  } else {
    dayNightCycle.transition = 1;
  }
}

// —Ü–≤–µ—Ç–∞ –Ω–µ–±–∞
const DAY_TOP = [0x87,0xCE,0xEB];     // #87CEEB
const DAY_BOTTOM = [0xE0,0xF7,0xFA];  // #E0F7FA
const NIGHT_TOP = [0x00,0x1D,0x3D];   // #001D3D
const NIGHT_BOTTOM = [0x00,0x10,0x24]; // #001024

function lerp(a,b,t){ return a + (b-a)*t; }
function colorToStr([r,g,b]){ return `rgb(${r|0},${g|0},${b|0})`; }

function drawSkyGradient(){
  // t: 0 ‚Äî –Ω–æ—á—å, 1 ‚Äî –¥–µ–Ω—å (—É—á–∏—Ç—ã–≤–∞–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å –ø–µ—Ä–µ—Ö–æ–¥–∞)
  const targetT = dayNightCycle.isDay ? 1 : 0;
  const t = dayNightCycle.transition * targetT + (1-dayNightCycle.transition) * (1-targetT);

  const top = [ lerp(NIGHT_TOP[0], DAY_TOP[0], t), lerp(NIGHT_TOP[1], DAY_TOP[1], t), lerp(NIGHT_TOP[2], DAY_TOP[2], t) ];
  const bottom = [ lerp(NIGHT_BOTTOM[0], DAY_BOTTOM[0], t), lerp(NIGHT_BOTTOM[1], DAY_BOTTOM[1], t), lerp(NIGHT_BOTTOM[2], DAY_BOTTOM[2], t) ];

  const grad = ctx.createLinearGradient(0,0,0,canvas.height);
  grad.addColorStop(0, colorToStr(top));
  grad.addColorStop(1, colorToStr(bottom));
  ctx.fillStyle = grad;
  ctx.fillRect(0,0,canvas.width,canvas.height);
}

// ====== –ö–æ–ª–ª–∏–∑–∏–∏ ======
function resolveCollisionsAxis(axis){
  let left = player.x, right = player.x + player.width, top = player.y, bottom = player.y + player.height;
  const startX = Math.floor(left / TILE_SIZE), endX = Math.floor((right-1) / TILE_SIZE);
  const startY = Math.floor(top / TILE_SIZE),  endY = Math.floor((bottom-1) / TILE_SIZE);

  for(let ty = startY; ty <= endY; ty++){
    for(let tx = startX; tx <= endX; tx++){
      if(tx<0||tx>=WORLD_WIDTH||ty<0||ty>=WORLD_HEIGHT) continue;
      const b = world[ty][tx];
      if(!isSolidBlock(b)) continue;
      const bx = tx * TILE_SIZE, by = ty * TILE_SIZE;
      if(right > bx && left < bx + TILE_SIZE && bottom > by && top < by + TILE_SIZE){
        if(axis === 'x'){
          if(player.velX > 0){
            if(canStepUp(1)) continue;
            player.x = bx - player.width - 0.01; player.velX = 0;
            left = player.x; right = player.x + player.width;
          } else if(player.velX < 0){
            if(canStepUp(-1)) continue;
            player.x = bx + TILE_SIZE + 0.01; player.velX = 0;
            left = player.x; right = player.x + player.width;
          }
        } else if(axis === 'y'){
          if(player.velY > 0){
            player.y = by - player.height - 0.01; player.velY = 0; player.onGround = true; player.isJumping = false;
            top = player.y; bottom = player.y + player.height;
          } else if(player.velY < 0){
            player.y = by + TILE_SIZE + 0.01; player.velY = 0;
            top = player.y; bottom = player.y + player.height;
          }
        }
      }
    }
  }
}

function canStepUp(dir){
  const originalY = player.y;
  const tryStep = Math.min(STEP_HEIGHT, TILE_SIZE);
  player.y -= tryStep;

  const left = Math.floor(player.x / TILE_SIZE);
  const right = Math.floor((player.x + player.width - 1) / TILE_SIZE);
  const top = Math.floor(player.y / TILE_SIZE);
  const bottom = Math.floor((player.y + player.height - 1) / TILE_SIZE);

  let blocked = false;
  for(let ty = top; ty <= bottom; ty++){
    for(let tx = left; tx <= right; tx++){
      if(tx<0||tx>=WORLD_WIDTH||ty<0||ty>=WORLD_HEIGHT) continue;
      if(isSolidBlock(world[ty][tx])) { blocked = true; break; }
    }
    if(blocked) break;
  }
  if(!blocked){ player.velY = -2; player.onGround = false; return true; }
  player.y = originalY; return false;
}

function updateGroundAndIceStatus(){
  const footY = player.y + player.height + 1;
  const leftX = player.x + player.width*0.25;
  const rightX = player.x + player.width*0.75;
  const leftTile = getTileAtXY(leftX, footY);
  const rightTile = getTileAtXY(rightX, footY);
  player.onGround = isSolidBlock(leftTile) || isSolidBlock(rightTile);
  player.onIce = (leftTile === BLOCKS.ICE) || (rightTile === BLOCKS.ICE);
}

// ====== –§–∏–∑–∏–∫–∞ ======
function updatePhysics(deltaTime){
  if(!isGameActive) return;

  updateDayNightCycle(deltaTime);

  const dtFactor = deltaTime/16;
  const gravity = 0.5;
  player.velY += gravity * dtFactor;

  // –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è
  player.velX = Math.max(-10, Math.min(10, player.velX));
  player.velY = Math.max(-40, Math.min(40, player.velY));

  // –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
  player.x += player.velX * dtFactor; resolveCollisionsAxis('x');
  player.y += player.velY * dtFactor; resolveCollisionsAxis('y');
  updateGroundAndIceStatus();

  // —Ç—Ä–µ–Ω–∏–µ
  if(player.onGround && !player.onIce){ player.velX *= 0.82; if(Math.abs(player.velX) < 0.05) player.velX = 0; }
  if(player.onIce) player.velX *= 0.995;

  // –≤ –≥—Ä–∞–Ω–∏—Ü–∞—Ö –º–∏—Ä–∞
  player.x = Math.max(0, Math.min(WORLD_WIDTH*TILE_SIZE - player.width, player.x));
  player.y = Math.min(WORLD_HEIGHT*TILE_SIZE - player.height, player.y);

  updateCamera();

  // –∞–Ω–∏–º–∞—Ü–∏—è –±–µ–≥–∞: —Ä–∞–±–æ—Ç–∞–µ—Ç –∏ –Ω–∞ –∑–µ–º–ª–µ, –∏ –≤ –≤–æ–∑–¥—É—Ö–µ, –µ—Å–ª–∏ –¥–µ—Ä–∂–∏—à—å –¥–≤–∏–∂–µ–Ω–∏–µ
  const movingIntent = Math.abs(inputTargetVX) > 0.1;
  player.walking = movingIntent; // —Ç–µ–ø–µ—Ä—å –Ω–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç onGround
  if(player.walking){
    player.frameTimer += deltaTime;
    if(player.frameTimer > player.frameInterval){
      player.frameTimer = 0;
      player.currentFrame = (player.currentFrame+1)%2;
    }
  } else {
    player.currentFrame = 0; player.frameTimer = 0;
  }

  // –∑–≤—É–∫ —à–∞–≥–æ–≤ ‚Äî —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ —Ä–µ–∞–ª—å–Ω–æ –¥–≤–∏–∂–µ–º—Å—è –ø–æ –∑–µ–º–ª–µ, —Å –∫—É–ª–¥–∞—É–Ω–æ–º 4 —Å–µ–∫
  if(player.onGround && Math.abs(player.velX) > 0.2){
    const now = performance.now();
    if(now - lastWalkAt >= 4000 && audioEnabled){
      lastWalkAt = now;
      try { walkSound.currentTime = 0; walkSound.play(); } catch(e){}
    }
  }
}

// ====== –í–≤–æ–¥ ======
const keys = {};
window.addEventListener('keydown', e=>{
  keys[e.key.toLowerCase()] = true;
  if(e.key===' ') e.preventDefault();
  if(e.key.toLowerCase()==='r') toggleCraftMenu();
});
window.addEventListener('keyup', e=>{ keys[e.key.toLowerCase()] = false; });

function handleInput(){
  if(!isGameActive) return;
  let targetVX = 0;
  if(keys['a'] || keys['arrowleft'] || keys['—Ñ']) targetVX = -player.speed;
  if(keys['d'] || keys['arrowright'] || keys['–≤']) targetVX =  player.speed;

  inputTargetVX = targetVX;

  const accel = player.onIce ? 0.05 : 0.34;
  player.velX += (targetVX - player.velX) * accel;

  if((keys['w'] || keys[' '] || keys['arrowup'] || keys['—Ü']) && player.onGround){
    player.velY = player.jumpForce; player.onGround = false; player.isJumping = true;
    if(audioEnabled){ try { jumpSound.currentTime = 0; jumpSound.play(); } catch(e){} }
  }
}

// ====== –ö–∞–º–µ—Ä–∞ ======
function updateCamera(){
  const targetX = player.x - canvas.width/2 + player.width/2;
  const targetY = player.y - canvas.height/2 + player.height/2;
  camera.x += (targetX - camera.x) * CAMERA_SMOOTHING;
  camera.y += (targetY - camera.y) * CAMERA_SMOOTHING;
  camera.x = Math.max(0, Math.min(WORLD_WIDTH*TILE_SIZE - canvas.width, camera.x));
  camera.y = Math.max(0, Math.min(WORLD_HEIGHT*TILE_SIZE - canvas.height, camera.y));
}

// ====== –°–Ω–µ–≥ ======
function updateSnowflakes(deltaTime){
  if(!isSnowing){ snowflakes=[]; return; }
  lastSnowflakeTime += deltaTime;
  if(lastSnowflakeTime > snowflakeInterval){
    lastSnowflakeTime = 0;
    const count = Math.floor(Math.random()*3)+1;
    for(let i=0;i<count;i++)
      snowflakes.push({ x: Math.random()*canvas.width, y:-10, size: Math.random()*3+2, speed: Math.random()*2+1, drift: Math.random()*2-1 });
  }
  for(let i=snowflakes.length-1;i>=0;i--){
    const f = snowflakes[i]; f.y += f.speed; f.x += f.drift*0.2; if(f.y > canvas.height+10) snowflakes.splice(i,1);
  }
}
function renderSnowflakes(){
  if(!isSnowing) return;
  ctx.save(); ctx.fillStyle='white';
  for(const f of snowflakes){ ctx.beginPath(); ctx.arc(f.x, f.y, f.size, 0, Math.PI*2); ctx.fill(); }
  ctx.restore();
}

// ====== –†–µ–Ω–¥–µ—Ä ======
function render(){
  // —Ñ–æ–Ω: –ø–æ–¥ –∑–µ–º–ª—ë–π ‚Äî —Ç—ë–º–Ω–æ-–∫–æ—Ä–∏—á–Ω–µ–≤—ã–π; –Ω–∞ –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏ ‚Äî –ø–ª–∞–≤–Ω—ã–π –≥—Ä–∞–¥–∏–µ–Ω—Ç –¥–µ–Ω—å/–Ω–æ—á—å
  const playerGridY = Math.floor((player.y + player.height/2) / TILE_SIZE);
  const underGround = playerGridY > WORLD_HEIGHT/2 + 6;
  if(underGround){
    ctx.fillStyle = '#2b1f14'; ctx.fillRect(0,0,canvas.width,canvas.height);
  } else {
    drawSkyGradient();
  }

  const startX = Math.max(0, Math.floor(camera.x / TILE_SIZE));
  const endX   = Math.min(WORLD_WIDTH, startX + Math.ceil(canvas.width / TILE_SIZE) + 1);
  const startY = Math.max(0, Math.floor(camera.y / TILE_SIZE));
  const endY   = Math.min(WORLD_HEIGHT, startY + Math.ceil(canvas.height / TILE_SIZE) + 1);

  for(let y=startY;y<endY;y++){
    for(let x=startX;x<endX;x++){
      const b = world[y][x]; if(b===BLOCKS.AIR || b===BLOCKS.CAVE_AIR) continue;
      const bx = x*TILE_SIZE - camera.x; const by = y*TILE_SIZE - camera.y;
      const key = `block_${b}`;
      if(textures[key]){
        if(b===BLOCKS.LEAVES||b===BLOCKS.FLOWER||b===BLOCKS.TALL_GRASS||b===BLOCKS.MOON_FLOWER||b===BLOCKS.SNOW){
          ctx.globalAlpha = 0.75; ctx.drawImage(textures[key], bx, by, TILE_SIZE, TILE_SIZE); ctx.globalAlpha = 1;
        } else {
          ctx.drawImage(textures[key], bx, by, TILE_SIZE, TILE_SIZE);
        }
      } else { ctx.fillStyle='#f00'; ctx.fillRect(bx,by,TILE_SIZE,TILE_SIZE); }
    }
  }

  // –∏–≥—Ä–æ–∫ ‚Äî –∞–Ω–∏–º–∞—Ü–∏—è; –≤ –ø—Ä—ã–∂–∫–µ –ø—Ä–∏ —É–¥–µ—Ä–∂–∞–Ω–∏–∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–∫–∞–∑—ã–≤–∞–µ–º "—Ö–æ–¥—å–±—É"
  let playerTexture = textures.player_stand || null;
  const movingIntent = Math.abs(inputTargetVX) > 0.1;
  if(!player.onGround && movingIntent){
    playerTexture = player.currentFrame===0 ? textures.player_right : textures.player_left;
  } else if(player.walking){
    playerTexture = player.currentFrame===0 ? textures.player_right : textures.player_left;
  } else {
    playerTexture = textures.player_stand;
  }

  if(playerTexture){
    ctx.save();
    const idleOffset = (player.velX===0 && player.onGround) ? Math.sin(Date.now()/300)*2 : 0;
    ctx.translate(player.x - camera.x + player.width/2, player.y - camera.y + player.height/2 + idleOffset);
    if(inputTargetVX < -0.1) player.lastDirection = -1;
    else if(inputTargetVX > 0.1) player.lastDirection = 1;
    if(player.lastDirection === -1) ctx.scale(-1,1);
    ctx.drawImage(playerTexture, -player.width/2, -player.height/2, player.width, player.height);
    ctx.restore();
  } else {
    ctx.fillStyle='#FF5722'; ctx.fillRect(player.x-camera.x, player.y-camera.y, player.width, player.height);
  }

  renderSnowflakes();
}

// ====== –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å –±–ª–æ–∫–∞–º–∏ ======
function isAdjacentToSolid(bx, by){
  // —Å–æ—Å–µ–¥ –ø–æ —Å—Ç–æ—Ä–æ–Ω–µ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ç–≤—ë—Ä–¥—ã–º
  const up    = (by-1)>=0                  ? world[by-1][bx] : BLOCKS.BEDROCK;
  const down  = (by+1)<WORLD_HEIGHT        ? world[by+1][bx] : BLOCKS.BEDROCK;
  const left  = (bx-1)>=0                  ? world[by][bx-1] : BLOCKS.BEDROCK;
  const right = (bx+1)<WORLD_WIDTH         ? world[by][bx+1] : BLOCKS.BEDROCK;
  return isSolidBlock(up) || isSolidBlock(down) || isSolidBlock(left) || isSolidBlock(right);
}

function handleBlockClick(e){
  const rect = canvas.getBoundingClientRect();
  const mx = e.clientX - rect.left;
  const my = e.clientY - rect.top;

  const mouseX = mx + camera.x;
  const mouseY = my + camera.y;
  const bx = Math.floor(mouseX / TILE_SIZE);
  const by = Math.floor(mouseY / TILE_SIZE);
  if(bx<0||bx>=WORLD_WIDTH||by<0||by>=WORLD_HEIGHT) return;

  const blockWorldX = bx * TILE_SIZE, blockWorldY = by * TILE_SIZE;

  // –¥–∏—Å—Ç–∞–Ω—Ü–∏—è –¥–æ —Ü–µ–Ω—Ç—Ä–∞ –±–ª–æ–∫–∞
  const dist = Math.hypot((blockWorldX+TILE_SIZE/2) - (player.x+player.width/2),
                          (blockWorldY+TILE_SIZE/2) - (player.y+player.height/2));
  if(dist > TILE_SIZE*PLACE_RANGE_TILES) return;

  // –Ω–µ–ª—å–∑—è —Å—Ç–∞–≤–∏—Ç—å –≤ —Ö–∏—Ç–±–æ–∫—Å –∏–≥—Ä–æ–∫–∞
  const willOverlapPlayer = !(blockWorldX + TILE_SIZE < player.x ||
                              blockWorldX > player.x + player.width ||
                              blockWorldY + TILE_SIZE < player.y ||
                              blockWorldY > player.y + player.height);

  if(e.button===0){
    // –°–¢–ê–í–ò–ú
    if(willOverlapPlayer){ showTooltip('–ù–µ–ª—å–∑—è —Å—Ç–∞–≤–∏—Ç—å –±–ª–æ–∫ –ø—Ä—è–º–æ –≤ –∏–≥—Ä–æ–∫–∞!'); return; }
    if(world[by][bx]===BLOCKS.AIR || world[by][bx]===BLOCKS.CAVE_AIR){
      if(!isAdjacentToSolid(bx,by)){ showTooltip('–ù–µ–ª—å–∑—è —Å—Ç–∞–≤–∏—Ç—å –≤ –≤–æ–∑–¥—É—Ö–µ!'); return; }
      if(player.selectedBlock !== BLOCKS.AIR && useFromInventory(player.selectedBlock)){
        world[by][bx]=player.selectedBlock;
      }
    }
  } else if(e.button===2){
    // –õ–û–ú–ê–ï–ú
    if(world[by][bx]!==BLOCKS.AIR && world[by][bx]!==BLOCKS.CAVE_AIR){
      const blockType = world[by][bx];

      let needTool = null;
      if((blockType===BLOCKS.STONE||blockType===BLOCKS.MOON_ROCK||blockType===BLOCKS.COAL||blockType===BLOCKS.IRON) && !player.tools.pickaxe) needTool='–∫–∏—Ä–∫—É';
      if((blockType===BLOCKS.DIRT||blockType===BLOCKS.GRASS||blockType===BLOCKS.SNOW_DIRT||blockType===BLOCKS.SNOW_GRASS) && !player.tools.shovel) needTool='–ª–æ–ø–∞—Ç—É';
      if((blockType===BLOCKS.WOOD||blockType===BLOCKS.PLANKS||blockType===BLOCKS.WORKBENCH) && !player.tools.axe) needTool='—Ç–æ–ø–æ—Ä';
      if(blockType===BLOCKS.SNOW && !player.tools.shovel) needTool='–ª–æ–ø–∞—Ç—É';

      if(needTool){ showTooltip(`–ù—É–∂–Ω–∞ ${needTool} –¥–ª—è —ç—Ç–æ–≥–æ –±–ª–æ–∫–∞!`); return; }

      if(blockType !== BLOCKS.BEDROCK){
        world[by][bx] = BLOCKS.AIR;
        if(blockType === BLOCKS.COAL) addToInventory(BLOCKS.COAL_ITEM);
        else addToInventory(blockType);
        if(audioEnabled){ try { breakSound.currentTime = 0; breakSound.play(); } catch(e){} }
      }
    }
  }
}

function showTooltip(msg){
  tooltip.textContent = msg; tooltip.style.opacity = 1;
  if(tooltipTimeout) clearTimeout(tooltipTimeout);
  tooltipTimeout = setTimeout(()=> tooltip.style.opacity = 0, 1800);
}

// ====== –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å ======
function initInventory(){
  inventoryDiv.innerHTML='';
  const order=[BLOCKS.GRASS,BLOCKS.DIRT,BLOCKS.STONE,BLOCKS.WOOD,BLOCKS.LEAVES,BLOCKS.FLOWER,BLOCKS.PLANKS,BLOCKS.TALL_GRASS,BLOCKS.MOON_ROCK,BLOCKS.MOON_FLOWER,BLOCKS.COAL_ITEM,BLOCKS.IRON,BLOCKS.SNOW,BLOCKS.SNOW_GRASS,BLOCKS.SNOW_DIRT,BLOCKS.ICE,BLOCKS.WORKBENCH];
  order.forEach(bid=>{
    if(player.inventory[bid]>0){
      const div=document.createElement('div');
      div.className='item';
      if(bid===BLOCKS.COAL_ITEM) div.style.backgroundImage=`url(${TEXTURES.items.coal})`;
      else div.style.backgroundImage=`url(${TEXTURES.blocks[bid]})`;
      const span=document.createElement('span'); span.className='item-count'; span.textContent=player.inventory[bid]||0;
      div.appendChild(span);
      div.onclick=()=>{
        document.querySelectorAll('#inventory .item').forEach(el=>el.classList.remove('active'));
        div.classList.add('active');
        player.selectedBlock=bid; player.tools.axe=false; player.tools.pickaxe=false; player.tools.shovel=false;
      };
      div.onmouseenter=()=>{
        blockNameDiv.textContent = BLOCK_NAMES[bid]||'–ë–ª–æ–∫';
        blockNameDiv.style.display='block';
        blockNameDiv.style.left = `${div.getBoundingClientRect().left + div.offsetWidth/2}px`;
        blockNameDiv.style.top = `${div.getBoundingClientRect().top - 10}px`;
      };
      div.onmouseleave=()=>{ blockNameDiv.style.display='none'; };
      inventoryDiv.appendChild(div);
    }
  });
}

function initTools(){
  toolsDiv.innerHTML='';
  const toolsOrder=[{id:'axe',name:'–¢–æ–ø–æ—Ä'},{id:'pickaxe',name:'–ö–∏—Ä–∫–∞'},{id:'shovel',name:'–õ–æ–ø–∞—Ç–∞'}];
  toolsOrder.forEach(t=>{
    const td=document.createElement('div');
    td.className='item'; td.style.backgroundImage=`url(${TEXTURES.items[t.id]})`;
    td.onclick=()=>{
      document.querySelectorAll('#tools .item').forEach(el=>el.classList.remove('active'));
      td.classList.add('active');
      player.tools.axe = t.id==='axe';
      player.tools.pickaxe = t.id==='pickaxe';
      player.tools.shovel = t.id==='shovel';
      player.selectedBlock = BLOCKS.AIR;
    };
    td.onmouseenter=()=>{
      blockNameDiv.textContent=t.name; blockNameDiv.style.display='block';
      blockNameDiv.style.left=`${td.getBoundingClientRect().left + td.offsetWidth/2}px`;
      blockNameDiv.style.top=`${td.getBoundingClientRect().top - 10}px`;
    };
    td.onmouseleave=()=> blockNameDiv.style.display='none';
    toolsDiv.appendChild(td);
  });
}

function addToInventory(blockType){
  if(player.inventory.hasOwnProperty(blockType)){
    player.inventory[blockType] = (player.inventory[blockType]||0) + 1;
    initInventory();
  }
}
function useFromInventory(blockType){
  if(player.inventory[blockType] > 0){
    player.inventory[blockType]--; initInventory(); return true;
  } return false;
}

// ====== –ö—Ä–∞—Ñ—Ç—ã ======
function craftPlanks(){
  if(player.inventory[BLOCKS.WOOD] >= 1){
    player.inventory[BLOCKS.WOOD]--;
    player.inventory[BLOCKS.PLANKS] = (player.inventory[BLOCKS.PLANKS]||0) + 5;
    initInventory(); showTooltip('1 –±—Ä–µ–≤–Ω–æ ‚Üí 5 –¥–æ—Å–æ–∫!');
    return true;
  } else { showTooltip('–ù—É–∂–Ω–æ 1 –±—Ä–µ–≤–Ω–æ –¥–ª—è –∫—Ä–∞—Ñ—Ç–∞!'); return false; }
}
function craftWorkbench(){
  if(player.inventory[BLOCKS.PLANKS] >= 15){
    player.inventory[BLOCKS.PLANKS] -= 15;
    player.inventory[BLOCKS.WORKBENCH] = (player.inventory[BLOCKS.WORKBENCH]||0) + 1;
    initInventory(); showTooltip('15 –¥–æ—Å–æ–∫ ‚Üí 1 –≤–µ—Ä—Å—Ç–∞–∫!');
    return true;
  } else { showTooltip('–ù—É–∂–Ω–æ 15 –¥–æ—Å–æ–∫ –¥–ª—è –∫—Ä–∞—Ñ—Ç–∞!'); return false; }
}
function toggleCraftMenu(){
  craftMenu.style.display = (craftMenu.style.display === 'flex' || craftMenu.style.display === 'block') ? 'none' : 'flex';
}
document.getElementById('craft_planks').addEventListener('click', craftPlanks);
document.getElementById('craft_workbench').addEventListener('click', craftWorkbench);

// ====== –ó–≤—É–∫ –∏ UI ======
audioToggle.addEventListener('click', ()=>{
  audioEnabled = !audioEnabled;
  audioToggle.textContent = audioEnabled ? 'üîä –ó–≤—É–∫ –í–ö–õ' : 'üîá –ó–≤—É–∫ –í–´–ö–õ';
  if(audioEnabled) backgroundMusic.play().catch(()=>{});
  else backgroundMusic.pause();
});
helpToggle.addEventListener('click', ()=>{
  showHelp = !showHelp; controlsHelp.style.display = showHelp ? 'block' : 'none';
});
craftButton.addEventListener('click', toggleCraftMenu);

canvas.addEventListener('mousedown', handleBlockClick);
canvas.addEventListener('contextmenu', e=>e.preventDefault());

// –∑–∞—â–∏—Ç–∞: –µ—Å–ª–∏ –≤–∫–ª–∞–¥–∫–∞ –±—ã–ª–∞ —Å–∫—Ä—ã—Ç–∞ ‚Äî –≤–æ–∑–≤—Ä–∞—Ç –∏ —Ä–µ—Å–µ—Ç –ø–∞–¥–µ–Ω–∏—è
document.addEventListener('visibilitychange', () => {
  isGameActive = !document.hidden;
  if (isGameActive) {
    if (player.y >= WORLD_HEIGHT * TILE_SIZE - player.height - 10) {
      player.x = spawnPoint.x; player.y = spawnPoint.y; player.velX = 0; player.velY = 0;
    }
  }
});

// ====== –ì–ª–∞–≤–Ω—ã–π —Ü–∏–∫–ª ======
function gameLoop(timestamp){
  const deltaTime = lastTime ? timestamp - lastTime : 16;
  lastTime = timestamp;

  handleInput();
  updatePhysics(deltaTime);

  const playerGridX = Math.floor((player.x + player.width/2) / TILE_SIZE);
  isSnowing = playerGridX >= snowBiomeStart && playerGridX <= snowBiomeEnd;
  updateSnowflakes(deltaTime);

  render();
  requestAnimationFrame(gameLoop);
}

function initGame(){
  canvas.width = window.innerWidth; canvas.height = window.innerHeight;
  player.x = spawnPoint.x; player.y = spawnPoint.y; player.velX = 0; player.velY = 0;
  if(audioEnabled){ backgroundMusic.volume = 0.3; backgroundMusic.play().catch(()=>{}); }
  initTools(); initInventory();
  requestAnimationFrame(gameLoop);
}

window.addEventListener('load', ()=>{
  initPlayerInventory(); generateWorld(); loadTextures(); initInventory();
});
window.addEventListener('resize', ()=>{
  canvas.width = window.innerWidth; canvas.height = window.innerHeight;
});

// –ü–æ–¥—Å–∫–∞–∑–∫–∏ (–Ω–∞ –±—É–¥—É—â–µ–µ)
function suggestions(){
  return ['–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ (offscreen canvas).','–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ/–∑–∞–≥—Ä—É–∑–∫–∞ –º–∏—Ä–∞ (localStorage).','–ß–∞—Å—Ç–∏—Ü—ã –∏ –∑–≤—É–∫–∏ –ø—Ä–∏ —Å–±–æ—Ä–µ.','–ú–æ–±–∏–ª—å–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ.','–ú–æ–±—ã –∏ –≤—Ä–∞–≥–∏.'];
}
</script>
</body>
</html>

